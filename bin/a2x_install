#!/usr/bin/env python3

import os
import re
import sys

from utils.output import Output
from utils.shell import Shell

def main():
    bin_dir = os.path.dirname(__file__)
    a2x_dir = os.path.abspath(os.path.join(bin_dir, ".."))

    config_read = os.path.join(a2x_dir, "cfg", "a2x.config")
    config_write = os.path.join(a2x_dir, "make", "sdk.config")

    make_command = sys.argv[1] if len(sys.argv) == 2 else ""
    Output.title("install", make_command)

    if make_command == "clean":
        if not os.path.exists(config_write):
            Output.error("{} does not exist"
                .format(os.path.basename(config_write)))
            Output.note("Run {}".format(sys.argv[0]))
            sys.exit(1)
    else:
        make_command = ""
        Output.info("Generating {}".format(os.path.basename(config_write)))

        db = {
            "sdk.open2x.root": ["OPEN2X_ROOT", None],
            "sdk.open2x.toolchain": ["OPEN2X_GLIBC", None],
            "sdk.caanoo.root": ["CAANOO_ROOT", None],
            "sdk.caanoo.toolchain": ["CAANOO_GLIBC", None],
            "sdk.pandora.root": ["PANDORA_ROOT", None],
            "sdk.pandora.toolchain": ["PANDORA_TOOLCHAIN", None],
        }

        with open(config_read, "rU") as f:
            re_assg = re.compile("(.*?)\s*=\s*(.*)$")

            for line in f:
                line = line.strip()
                assg = re_assg.match(line)

                if not assg or line[0] == "#":
                    continue

                key = assg.group(1)

                if key in db.keys():
                    db[key][1] = assg.group(2)

        with open(config_write, "w") as f:
            for key in db:
                if db[key][1]:
                    f.write("{} = {}\n".format(db[key][0], db[key][1]))

    if make_command == "clean":
        Output.info("Removing all compiled and generated a2x files")
    else:
        Output.note("Add {} to $PATH".format(a2x_dir))
        Output.info("Compiling a2x and tools")

    Shell.run("cd {} && make {}"
        .format(os.path.join(a2x_dir, "make", "a2x"),
                make_command))

    Shell.run("cd {} && make {}"
        .format(os.path.join(a2x_dir, "bin", "tools", "gfx"),
                make_command))

    Shell.run("cd {} && make {}"
        .format(os.path.join(a2x_dir, "bin", "tools", "sfx"),
                make_command))

    if make_command == "clean":
        Shell.run("rm -f {}".format(config_write))
    else:
        Shell.run("cd {} && make tags"
            .format(os.path.join(a2x_dir, "make", "a2x")))

if __name__ == "__main__":
    main()
