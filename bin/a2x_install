#!/usr/bin/env python3

import os
import re
import sys

from utils.output import Output
from utils.shell import Shell

def main():
    Output.title('install', sys.argv)

    bin_dir = os.path.dirname(__file__)
    a2x_dir = os.path.abspath(os.path.join(bin_dir, '..'))

    config_read = os.path.join(a2x_dir, 'cfg', 'a2x.config')
    config_write = os.path.join(a2x_dir, 'make', 'sdk.config')

    make_command = sys.argv[1] if len(sys.argv) == 2 else ''

    if make_command == 'clean':
        if not os.path.exists(config_write):
            Output.note('Run {} first'.format(sys.argv[0]))
            Output.error('{} does not exist'
                .format(os.path.basename(config_write)))

        Output.info('Removing all compiled and generated a2x files')
    else:
        make_command = ''
        Shell.run(os.path.join(a2x_dir, 'bin', 'a2x_sdkconfig'))
        Output.note('Add {} to $PATH'.format(a2x_dir))
        Output.info('Compiling a2x and tools')

    Shell.run('cd {} && make {}'
        .format(os.path.join(a2x_dir, 'make', 'a2x'),
                make_command))

    Shell.run('cd {} && make {}'
        .format(os.path.join(a2x_dir, 'bin', 'tools', 'gfx'),
                make_command))

    Shell.run('cd {} && make {}'
        .format(os.path.join(a2x_dir, 'bin', 'tools', 'sfx'),
                make_command))

    if make_command == 'clean':
        Shell.run('rm -f {}'.format(config_write))
    else:
        Shell.run('cd {} && make tags'
            .format(os.path.join(a2x_dir, 'make', 'a2x')))

    Output.info('Done')

if __name__ == '__main__':
    main()
