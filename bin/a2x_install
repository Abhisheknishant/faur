#!/usr/bin/env python3

import os, re, subprocess, sys

def main():
    def call(cmd):
        subprocess.call(cmd, shell = True)

    bin_dir = os.path.dirname(__file__)
    a2x_dir = os.path.abspath(os.path.join(bin_dir, ".."))

    config_read = os.path.join(a2x_dir, "cfg", "a2x.config")
    config_write = os.path.join(a2x_dir, "make", "sdk.config")

    make_command = ""

    if len(sys.argv) == 2 and sys.argv[1] == "clean":
        make_command = "clean"

        print("Cleaning a2x (removing all compiled and generated files)")
        print("--------------------------------------------------------")

        if not os.path.exists(config_write):
            print(os.path.basename(config_write) + " does not exist")
            print("Run " + sys.argv[0])
            return
    else:
        print("Installing a2x (compiling and generating files)")
        print("Dependencies: SDL, SDL_mixer, libpng")
        print("Add {} to $PATH".format(a2x_dir))
        print("-----------------------------------------------")
        print("Generating {}".format(os.path.basename(config_write)))

        db = {
            "sdk.open2x.root": ["OPEN2X_ROOT", None],
            "sdk.open2x.toolchain": ["OPEN2X_GLIBC", None],
            "sdk.caanoo.root": ["CAANOO_ROOT", None],
            "sdk.caanoo.toolchain": ["CAANOO_GLIBC", None],
            "sdk.pandora.root": ["PANDORA_ROOT", None],
            "sdk.pandora.toolchain": ["PANDORA_TOOLCHAIN", None],
        }

        with open(config_read, "rU") as f:
            re_assg = re.compile("(.*?)\s*=\s*(.*)$")

            for line in f:
                line = line.strip()
                assg = re_assg.match(line)

                if not assg or line[0] == "#":
                    continue

                key = assg.group(1)

                if key in db.keys():
                    db[key][1] = assg.group(2)

        with open(config_write, "w") as f:
            for key in db:
                if db[key][1]:
                    f.write("{} = {}\n".format(db[key][0], db[key][1]))

    call("cd {}; make {}" \
        .format(os.path.join(a2x_dir, "make", "a2x"),
                make_command))

    call("cd {}; make tags" \
        .format(os.path.join(a2x_dir, "make", "a2x")))

    call("cd {}; make {}" \
        .format(os.path.join(a2x_dir, "bin", "tools", "gfx"),
                make_command))

    call("cd {}; make {}" \
        .format(os.path.join(a2x_dir, "bin", "tools", "sfx"),
                make_command))

    if make_command == "clean":
        call("rm -f {}".format(config_write))

if __name__ == "__main__":
    main()
