#!/usr/bin/env python3

import os
import sys

from utils.output import Output

def newdir(name):
    Output.info('Making dir: {}'.format(name))
    os.mkdir(name)

def newfile(name, contents):
    Output.info('Writing file: {}'.format(name))

    with open(name, 'w') as f:
        f.write(contents)

def main():
    Output.title('new', sys.argv)

    if len(sys.argv) != 2:
        Output.error('Usage: {} ProjectPath'
            .format(os.path.basename(sys.argv[0])))

    a2x_dir = os.path.abspath(sys.path[0])

    Output.info('Found a2x: {}'.format(a2x_dir))

    project_path = sys.argv[1]
    project_name = os.path.basename(project_path)

    if os.path.exists(project_path):
        Output.error('Error: {} already exists'.format(project_name))

    newdir(project_path)
    newdir(os.path.join(project_path, 'make'))
    newdir(os.path.join(project_path, 'src'))

    newfile(os.path.join(project_path, 'make', 'Makefile'),
"""APP = {0}
TARGET_DIR = ..
SRC_DIR = ../src
GFX_DIR =
SFX_DIR =
OBJ_DIR = ../obj
A2X_PATH = {1}/..
include $(A2X_PATH)/make/project/Makefile.linux
""".format(project_name, a2x_dir))

    newfile(os.path.join(project_path, 'src', 'main.c'),
"""#include <a2x.h>

A_SETUP
{{
    a_settings_set("app.title", "{0}");
    a_settings_set("app.version", "1.0");
    a_settings_set("app.author", "{1}");
    a_settings_set("app.quiet", "no");
}}

A_MAIN
{{
    printf("Code me!\\n");
}}
""".format(project_name, os.getlogin()))

    Output.note('{} is ready!'.format(project_name))
    Output.info('Done')

if __name__ == '__main__':
    main()
